const express = require("express");
const { google } = require("googleapis");
const { Client, GatewayIntentBits } = require("discord.js");

const app = express();
const PORT = process.env.PORT || 3000;

// =====================
// Discord
// =====================
const discordClient = new Client({
  intents: [GatewayIntentBits.Guilds]
});

discordClient.once("ready", () => {
  console.log(`Discord bot logged in as ${discordClient.user.tag}`);
});

discordClient.login(process.env.DISCORD_TOKEN);

// =====================
// Google OAuth
// =====================
const oauth2Client = new google.auth.OAuth2(
  process.env.GOOGLE_CLIENT_ID,
  process.env.GOOGLE_CLIENT_SECRET,
  process.env.GOOGLE_REDIRECT_URI
);

// קישור התחברות לגוגל
app.get("/auth/google", (req, res) => {
  const url = oauth2Client.generateAuthUrl({
    access_type: "offline",
    scope: ["https://www.googleapis.com/auth/calendar.readonly"]
  });

  res.redirect(url);
});

// Callback אחרי אישור
app.get("/oauth/callback", async (req, res) => {
  try {
    const { code } = req.query;

    const { tokens } = await oauth2Client.getToken(code);
    oauth2Client.setCredentials(tokens);

    res.send("✅ Google Calendar connected successfully!");
  } catch (err) {
    console.error(err);
    res.status(500).send("OAuth failed");
  }
});

// =====================
// בדיקת קריאת אירועים (יומן אחד בלבד)
// =====================
app.get("/test-calendar", async (req, res) => {
  try {
    const calendar = google.calendar({
      version: "v3",
      auth: oauth2Client
    });

    const events = await calendar.events.list({
      calendarId: process.env.GCAL_CALENDAR_ID,
      maxResults: 5,
      singleEvents: true,
      orderBy: "startTime"
    });

    res.json(events.data.items || []);
  } catch (err) {
    console.error(err);
    res.status(500).send("Failed to fetch events");
  }
});

// =====================
app.get("/", (req, res) => {
  res.send("Backend is running ✅");
});

app.listen(PORT, () => {
  console.log(`Server running on port ${PORT}`);
});
